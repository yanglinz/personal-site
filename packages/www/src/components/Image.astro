---
import type { CollectionEntry } from "astro:content";
import path from "node:path";
import Image from "@11ty/eleventy-img";

interface Props {
  slug: string;
  data: CollectionEntry<"posts">;
}

const { slug, data } = Astro.props;

async function imageShortcode(
  src: any,
  alt: any,
  sizes = "(min-width: 30em) 50vw, 100vw"
) {
  const rootPath = "/Users/yz/Dev/personal-site/packages/www";
  let metadata = await Image(src, {
    widths: [480, 780, 1000, 1400, 2200],
    formats: ["avif", "webp", "jpeg"],
    outputDir: path.join(rootPath, "public/img"),
    urlPath: "/img/",
  });

  let lowsrc = metadata.jpeg[0];
  let highsrc = metadata.jpeg[metadata.jpeg.length - 1];

  const sources = Object.values(metadata)
    .map((imageFormat) => {
      const type = imageFormat[0].sourceType;
      const srcset = imageFormat.map((entry) => entry.srcset).join(", ");
      return `<source type="${type}" srcset="${srcset}" sizes="${sizes}">`;
    })
    .join("\n");

  return `<div class="s-image" style="aspect-ratio: ${highsrc.width} / ${highsrc.height}">
    <picture>
      ${sources}
      <img
        src="${lowsrc.url}"
        alt="${alt}"
        width="100%"
        loading="lazy"
        decoding="async"
      />
    </picture>
  </div>`;
}

const rootPath = "/Users/yz/Dev/personal-site/packages/www";
// const imagePath = path.resolve(__dirname, "../content/posts/service-boundaries/banner.jpg");
const imagePath = path.resolve(
  rootPath,
  "src/content/posts",
  slug,
  (data as any).featuredImage
);
const imageHtml = await imageShortcode(imagePath, "TODO: Alt text");

console.log(imageHtml);
---

<figure>
  <Fragment set:html={imageHtml} />
</figure>
